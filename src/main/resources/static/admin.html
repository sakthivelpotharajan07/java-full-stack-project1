<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Zidio Connect</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav >
    <h1 class="text-2xl font-bold">Zidio Connect - Admin</h1>
    <p>Welcome, <span id="adminName"></span>!</p>
    <button onclick="logout()">Logout</button>
</nav>
<div>
    <h2 >Manage Users</h2>
    <table>
        <thead><tr><th class="border p-2">ID</th><th class="border p-2">Name</th><th class="border p-2">Email</th><th class="border p-2">Role</th><th class="border p-2">Action</th></tr></thead>
        <tbody id="usersTable"></tbody>
    </table>
    <h2 >Manage Jobs</h2>
    <table>
        <thead><tr><th class="border p-2">ID</th><th class="border p-2">Title</th><th class="border p-2">Recruiter</th><th class="border p-2">Action</th></tr></thead>
        <tbody id="jobsTable"></tbody>
    </table>
    <h2>Manage Applications</h2>
    <table>
        <thead><tr ><th class="border p-2">App ID</th><th class="border p-2">Job Title</th><th class="border p-2">Student</th><th class="border p-2">Status</th><th class="border p-2">Action</th></tr></thead>
        <tbody id="applicationsTable"></tbody>
    </table>
</div>

<script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== "ROLE_ADMIN") {
        window.location.href = "login.html";
    }
    document.getElementById("adminName").textContent = user.name;

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem("authToken");
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        const response = await fetch(url, { ...options, headers });
        if(response.status === 401 || response.status === 403) {
            logout();
        }
        return response;
    }

    function renderTable(tbodyId, data, renderRowFunc) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";
        data.forEach(item => {
            const row = tbody.insertRow();
            renderRowFunc(row, item);
        });
    }

    async function fetchUsers() {
        const res = await fetchWithAuth("http://localhost:8080/api/admin/users");
        const users = await res.json();
        renderTable("usersTable", users, (row, u) => {
            row.insertCell().textContent = u.userId;
            row.insertCell().textContent = u.name;
            row.insertCell().textContent = u.email;
            row.insertCell().textContent = u.role;
            const actionCell = row.insertCell();
            if (u.role !== 'ROLE_ADMIN') {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'bg-red-500 px-2 py-1 rounded text-white';
                deleteBtn.onclick = () => deleteUser(u.userId);
                actionCell.appendChild(deleteBtn);
            }
        });
    }

    async function fetchJobs() {
        const res = await fetchWithAuth("http://localhost:8080/api/admin/jobs");
        const jobs = await res.json();
        renderTable("jobsTable", jobs, (row, j) => {
            row.insertCell().textContent = j.jobId;
            row.insertCell().textContent = j.title;
            row.insertCell().textContent = j.recruiter ? j.recruiter.name : 'N/A';
            const actionCell = row.insertCell();
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'bg-red-500 px-2 py-1 rounded text-white';
            deleteBtn.onclick = () => deleteJob(j.jobId);
            actionCell.appendChild(deleteBtn);
        });
    }

    async function fetchApplications() {
        const res = await fetchWithAuth("http://localhost:8080/api/admin/applications");
        const apps = await res.json();
        renderTable("applicationsTable", apps, (row, a) => {
            row.insertCell().textContent = a.applicationId;
            row.insertCell().textContent = a.job.title;
            row.insertCell().textContent = a.student.name;
            row.insertCell().textContent = a.status;
            const actionCell = row.insertCell();
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'bg-red-500 px-2 py-1 rounded text-white';
            deleteBtn.onclick = () => deleteApplication(a.applicationId);
            actionCell.appendChild(deleteBtn);
        });
    }

    async function deleteUser(id) {
        if (confirm(`Are you sure you want to delete user ${id}?`)) {
            await fetchWithAuth(`http://localhost:8080/api/admin/users/${id}`, { method: "DELETE" });
            fetchUsers();
        }
    }

    async function deleteJob(id) {
        if (confirm(`Are you sure you want to delete job ${id}?`)) {
            await fetchWithAuth(`http://localhost:8080/api/admin/jobs/${id}`, { method: "DELETE" });
            fetchJobs();
        }
    }

    async function deleteApplication(id) {
        if (confirm(`Are you sure you want to delete application ${id}?`)) {
            await fetchWithAuth(`http://localhost:8080/api/admin/applications/${id}`, { method: "DELETE" });
            fetchApplications();
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = "index.html";
    }

    window.onload = () => {
        fetchUsers();
        fetchJobs();
        fetchApplications();
    };
</script>
</body>
</html>